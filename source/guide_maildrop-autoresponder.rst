.. highlight:: console

.. author:: Achim | pxlfrk <hallo@pxlfrk.de>

.. tag:: mail
.. tag:: bouncer
.. tag:: maildrop
.. tag:: qmail
.. tag:: courier



.. sidebar:: About

  .. image:: _static/images/maildrop_autoreply.svg
      :align: center

######################
Maildrop Autoresponder
######################

.. tag_list::

The following guide allows you to enable a custom autoresponder for a specific mail address by using the built-in maildrop_ in addition to mailbot_, qmail_ and some tweaks.


----

.. note:: For this guide you should be familiar with the basic concepts of

  * :manual:`domains <mail-domains>`
  * :manual:`mailboxes <mail-mailboxes>`
  * :manual:`webmail <mail-access>`


Prerequisites
=============

If you're planning to use your own domain for mail with your Uberspace, you need to set it up before. Refer to the :manual:`manual <mail-domains>` and come back when your done.

Installation
============

For this guide, let's assume that you have created a mail user ``email``. We'll also assume that your email address is therefore ``email@stardust.uber.space``. If you're using an external domain, e.g. ``domain.tld``, refer to it accordingly. Make sure to replace these placeholder tags with your own credentials and usernames.

Create the autoreply-filter
---------------------------

Create a directory to store your configurations and keep your home directory nice and clean. Use your favourite editor to create ``~/autoresponder/.autoreply-filter`` with the following content. We'll split the content in multiple parts to explain what they're doing. Make sure you don't miss one, otherwise the filter won't work!

.. code-block:: console

 [isabell@stardust ~]$ mkdir autoresponder
 [isabell@stardust autoresponder]$

.. code-block:: bash

	# set default Maildir
	MAILDIR="$HOME/Maildir"

	# check if we're called from a .qmail-EXT instead of .qmail
	# If you're using a separate mail user (not the primary), we setup the MAILDIR accordingly
	import EXT
	if ( $EXT )
	{
		# does a vmailmgr user named $EXT exist?
		# if yes, deliver mail to their Maildir instead
		CHECKMAILDIR = `dumpvuser $EXT | grep '^Directory' | awk '{ print $2 }'`
		if ( $CHECKMAILDIR )
		{
			MAILDIR="$HOME/$CHECKMAILDIR"
		}
	}

The variable ``$MAILDIR`` defines where maildrop finds the maildir and what it is. The example checks whether the call is for a specific mailbox or the main mailbox.

.. code-block:: bash

	# If you don't want to debug the autoresponder, turn off logging by commenting out the following line.
	logfile "$HOME/autoresponder/autoreply-filter.log"

We strongly recommend enabling logging. If everything works you can safely disable this afterwards. The logfile ``~/autoresponder/autoreply-filter.log`` will be created showing the sender, date, subject and final destination for each mail processed by the filter.

.. code-block:: bash

	# Set the sender for the autoreply-email
	FROM="email@stardust.uber.space"

Configure the email address shown as sender from your generated mails.

.. note:: I recommend to create one filter file for each autoresponder to prevent the use of generic sender addresses, but it's not necessary though.

.. code-block:: bash

	# show the mail to the uberspace spam filtering algorithm
	include "$HOME/.spamfolder"

We don't want to reply to Spam-Mails, therefore we hand over the incoming mails to the uberspace-spam-filtering. If the email is not recognized as spam, we'll continue processing. Otherwise it's either being sorted in the ``.spam``-Folder in the user's mailbox.

.. code-block:: bash

	# reply to mail with the following text and given parameters
	cc "| mailbot -t $HOME/autoresponder/autoresponse.txt -N -A 'From: $FROM' -d $HOME/autoresponder/bouncedb -D 3 /var/qmail/bin/qmail-inject -f ''"


**This is the place to configure the autoresponder.** We`ll set a reference to a ``reply-message.txt`` (or any other named)-file somewhere on your uberspace. ``mailbot`` will take the content of the specified file and use it as text for the reply-mail without further adjustments.

.. note:: This method is simple and efficient if you use it for yourself. But if you're planning to use this solution to handle multiple users with their own mailboxes and you aren't willing to give everyone access to the server by SSH, SFTP etc. to modify their response-messages head over to `One more thing`_ for an additional method.

``mailbot`` requires some additional parameters:

  * ``-t $HOME/autoresponder/autoresponse.txt``: Read the text for the autoresponse from the referenced file.
  * ``-A 'From: $FROM'``: Adds a header to the response. In our case, we'll set the ``From:`` header in the autogenerated response.
  * ``-N``: Disables quoting the original message
  * ``-d $HOME/autoresponder/bouncedb``: Creates a small database ``bouncedb`` in the specified path, that keeps track of senders' E-mail addresses, and prevent duplicate autoresponses going to the same address. Another autoresponse to the same address will not be mailed until at least the amount of time specified by the -D option has elapsed.
  * ``-D 3``: Do not send duplicate autoresponses (see the -d flag) for at least ``3`` days (default: 1 day).
  * ``/var/qmail/bin/qmail-inject -f ''``: utility to send the mail

.. note:: Refer to the `mailbot documentation`_ for more detailed informations how to use flags.

We have to make sure that all referenced directories and files exist, otherwise mailbot will abort immediately. Since we referred the ``autoresponse.txt`` file in the configuration above we 'll create it.

Finally, add this last block to your ``~/autoresponder/.autoreply-filter``:

.. code-block:: bash

	# Receive the mail (the original mail goes into your INBOX)
	to "$MAILDIR"

This line makes sure that the email is delivered to your ``$MAILDIR`` in any case, no matter which filters & rules were triggered before.


.. warning:: Attention: The configuration must only be readable by the user who executes the maildrop command, **otherwise maildrop aborts immediately without delivering the e-mail**. For this reason, the access rights must be set after creation:

.. code-block:: console

 [isabell@stardust ~]$ chmod 600 ~/autoresponder/.autoreply-filter

Create the qmail
----------------

Use your favourite editor to create ``~/.qmail-email`` with the following content (including the pipe):

.. code-block:: bash

	|maildrop $HOME/autoresponder/.autoreply-filter

All incoming mails will now be forwarded to ``maildrop``, which executes the filterfile ``~/autoresponder/.autoreply-filter`` that we will create in the next step.

.. warning::  Make sure that you use UNIX Line-endings_ in this file, **otherwise it won't work.**

Usage
=====

Disabling and Enabling
----------------------

You can easily disable and enable the autoresponse at any given time. There are multiple solutions:

  * Un-/comment the ``cc`` command in the ``~/.autoreply-filter``-file
  * remove or rename / add the specified ``txt``-message


Behaviour by mailing lists
--------------------------
By default ``mailbot`` won't reply to mails that are marked correctly as part of a mailing list. The default behavior is to send an autoresponse unless the original message has the ``Precedence: junk`` or the ``Precedence: bulk`` header, or the ``Precedence: list`` header, or the ``List-ID:`` header, or if its MIME content type is ``multipart/report`` (this is the MIME content type for delivery status notifications).


One more thing
==============

.. note :: In Addition to the method described above there is another way, making the handling of the autoresponder very easy, especially for not-so-techie users. This solution comes in handy especially with multiple users or if its not possible (or recommendable) giving each user file access to the server by e.g. SFTP.

You can set a reference to a specific IMAP-Folder in the user's mailbox. ``mailbot`` will take the most recent message in there and send it as a reply to the sender.

The stored email can be both plaintext and HTML. If there's no mail stored in the specified folder mailbot won't do anything. The only downside of this solution to be mentioned: mailbot takes the incoming mail and will add it as an attachment to the replied message. Unfortunately there is no way to disable this behaviour.

Installation
------------

In the ``~/autoresponder/.autoreply-filter`` the only thing that changes is the ``cc`` command.

Use your favourite editor to edit ``~/autoresponder/.autoreply-filter``. Remove these lines

.. code-block:: bash

	# reply to mail with the following text and given parameters
	cc "| mailbot -t $HOME/autoresponder/autoresponse.txt -N -A 'From: $FROM' -d $HOME/autoresponder/bouncedb -D 3 /var/qmail/bin/qmail-inject -f ''"

and replace them with the following lines:

.. code-block:: bash

	# using the mail stored in the referenced IMAP-Folder to reply
	cc "| mailbot -T replydraft -l '$MAILDIR/.Autoresponder' -N  -A 'From: $FROM' -d $HOME/autoresponder/bouncedb -D 3 /var/qmail/bin/qmail-inject -f ''"

You can customize the ``cc``-command to your needs:

Configuration
------------

``mailbot`` requires some additional parameters:

  * ``-T replydraft``: Specifies the type of reply
  * ``-l '$MAILDIR/.Autoresponder'``: Specifies the ``IMAP``-Folder in the ``$MAILDIR`` (aka. mailbox). Mailbox will use the most recent message in this folder and reply it to the sender
  * ``-N``: Disables quoting the original message
  * ``-A 'From: $FROM'``: Adds a header to the response. In our case, we'll set the ``From:`` header in the autogenerated response.
  * ``-d $HOME/autoresponses/bouncedb``: Creates a small database ``bouncedb`` in the specified path, that keeps track of senders' E-mail addresses, and prevent duplicate autoresponses going to the same address. Another autoresponse to the same address will not be mailed until at least the amount of time specified by the -D option has elapsed.
  * ``-D 3``: Do not send duplicate autoresponses (see the -d flag) for at least ``3`` days (default: 1 day).
  * ``/var/qmail/bin/qmail-inject -f ''``: utility to send the mail

.. note :: ``-N`` is useless when using ``-T replydraft``. Unfortunately there is no way to disable this behaviour. Nevertheless is set to prevent syntax issues.

Since we refer to the ``IMAP``-Folder ``Autorespond`` in the users mailbox tell them to create them and store a message there. Use your favorite IMAP-Client to create & save a new draft. Afterwards move the draft to the ``Autoresponder`` folder. Its not necessary to enter any recipients, mailbot will delete them anyway. Now you're done!

.. note :: You can choose a different name for the IMAP-Folder. Make sure to change the reference in the ``~/.autoreply-filter`` file then accordingly.

Usage
-----

When you're using the IMAP method you can additionally disable or enable the autoresponder by removing or adding a mail in the specified ``IMAP``-Folder. Mailbot will always use the most recent draft present in the specified folder.


Common Issues
=============
In case you configured the autoresponder as described above but it doesn't work, check the following things as they are the most common issues.

Line-endings
------------
Maildrop necessarily expects Unix line breaks ``\n``. If the filter file is encoded with Windows ``\r\n`` or traditional Mac line breaks ``\r``, all kinds of bizarre behavior may occur.

.. code-block:: console

 [isabell@stardust ~]$ dos2unix ~/autoresponder/.autoreply-filter


File permissions
----------------
The configuration must only be readable by the user who executes the maildrop command, **otherwise maildrop aborts immediately without delivering the e-mail**. For this reason, the access rights must be set to ``600``. You can easily set this by entering the following command:

.. code-block:: console

 [isabell@stardust ~]$ chmod 600 ~/autoresponder/.autoreply-filter

Acknowledgements
================
 * This guide is based on the official `mailbot documentation`_ and the `IMAP reply script by tpraxl <https://gist.github.com/tpraxl/6d5be3527490fb51f33ae5eafe747714>`_.
 * The envelope icon is made by `pixel perfect`_ from Flaticon_.

.. _Flaticon: https://www.flaticon.com/
.. _pixel perfect: https://www.flaticon.com/authors/pixel-perfect
.. _mailbot documentation: https://www.courier-mta.org/maildrop/mailbot.html
.. _qmail: https://cr.yp.to/qmail.html
.. _maildrop: https://www.courier-mta.org/maildrop/
.. _mailbot: https://www.courier-mta.org/maildrop/mailbot.html

----

Tested with Maildrop 2.9.2, Uberspace 7.5.1.0

.. author_list::

