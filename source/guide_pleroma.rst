.. highlight:: console
.. author:: Arian Malek

.. tag:: lang-elixir
.. tag:: microblogging

.. sidebar:: Logo

  .. image:: _static/images/pleroma.svg
      :align: center

#########
Pleroma
#########

.. tag_list::

Pleroma_ is a free, federated social networking server built on open protocols. It is compatible with `GNU Social`_, Mastodon_, and many other ActivityPub implementations.

----

.. note:: For this guide you should be familiar with the basic concepts of

  * :lab:`PostgreSQL <guide_postgresql>`
  * :manual:`Domains <web-domains>`
  * :manual:`Web Backend <web-backend>`  

Prerequisites
=============

Your URL needs to be setup:

.. include:: includes/web-domain-list.rst

You should've running a :lab:`PostgreSQL <guide_postgresql>` in the version ``9.6`` or above configured with ``--with-uuid=e2fs``

::

 [isabell@stardust ~]$ ./configure --prefix=$HOME/opt/postgresql/ --with-python PYTHON=/usr/bin/python2 --without-readline --with-uuid=e2fs
 [isabell@stardust ~]$

In PostgreSQL you need a database with your username as name. Otherwise there is an error when you create the database for pleroma.

.. warning:: Please replace ``<username>`` with your Uberspace username created in :lab:`PostgreSQL <guide_postgresql>`!

::

 [isabell@stardust ~]$ createdb --encoding=UTF8 --owner=<username> <username>
 [isabell@stardust ~]$

Installation
============

Create a ``pleroma`` directory in your home and download the latest stable release from source. You dont need to ``cd`` the new directory because ``git clone`` download the files automatically in the new created ``pleroma`` directory.

::

 [isabell@stardust ~]$ mkdir ~/pleroma
 [isabell@stardust ~]$ git clone -b stable https://git.pleroma.social/pleroma/pleroma.git
 Cloning into 'pleroma'...
 remote: Enumerating objects: 1130, done.
 remote: Counting objects: 100% (1130/1130), done.
 remote: Compressing objects: 100% (143/143), done.
 remote: Total 105264 (delta 1020), reused 1080 (delta 984), pack-reused 104134
 Receiving objects: 100% (105264/105264), 144.76 MiB | 4.11 MiB/s, done.
 Resolving deltas: 100% (79785/79785), done.
 Updating files: 100% (4920/4920), done.
 [isabell@stardust ~]$

``cd`` to the new pleroma directory and run ``mix deps.get`` to install elixir dependencies:

::

 [isabell@stardust ~]$ cd ~/pleroma
 [isabell@stardust ~]$ mix deps.get
 [...]
 [isabell@stardust ~]$

Configuration
=============

Generate configuration file
---------------------------

.. note:: The next step can take up to 10 minutes.

Run ``mix pleroma.instance gen``. This will compiling the files and asks you questions about your instance and generate a configuration file in ``config/generated_config.exs``.

.. warning:: Make sure to set the listen port to ``0.0.0.0`` instead of ``127.0.0.1`` !

::

 [isabell@stardust ~]$ mix pleroma.instance gen
 [...]
 Generated pleroma app
 What domain will your instance use? (e.g pleroma.soykaf.com) []  isabell.uber.space
 What is the name of your instance? (e.g. The Corndog Emporium) [isabell.uber.space]  Isabell
 What is your admin email address? []  isabell@uber.space
 What email address do you want to use for sending email notifications? [isabell@uber.space]  isabell@uber.space
 Do you want search engines to index your site? (y/n) [y]  y
 Do you want to store the configuration in the database (allows controlling it from admin-fe)? (y/n) [n]  n
 What is the hostname of your database? [localhost]  localhost
 What is the name of your database? [pleroma]  pleroma
 What is the user used to connect to your database? [pleroma]  pleroma
 What is the password used to connect to your database? [autogenerated]  MySuperSecretPassword
 Would you like to use RUM indices? [n]  n
 What port will the app listen to (leave it if you are using the default setup with nginx)? [4000]  4000
 What ip will the app listen to (leave it if you are using the default setup with nginx)? [127.0.0.1]  0.0.0.0
 What directory should media uploads go in (when using the local uploader)? [uploads]  uploads
 What directory should custom public files be read from (custom emojis, frontend bundle overrides, robots.txt, etc.)? [instance/static/]  instance/static/
 Writing config to config/generated_config.exs.
 Writing the postgres script to config/setup_db.psql.
 Writing instance/static/robots.txt.
 
 All files successfully written! Refer to the installation instructions for your platform for next steps.
 [isabell@stardust ~]$

Create new PostgreSQL user and database from file
-------------------------------------------------

You have a PostgreSQL file in ``config/setup_db.psql``. This script creates the user ``pleroma`` with your password ``MySecretPassword`` you gave above and the database ``pleroma``  with the user ``pleroma`` as owner. Additional it install the extensions ``citext``, ``pg_trgm`` and ``uuid-ossp`` to the database. 
Run the script with ``psql``:

.. I noticed a error when I want to run the script. With a fresh new postgresql instance I got the following error: ``psql: error: could not connect to server: FATAL: database "$uberspace_username" does not exist``. I dont know if this is a feature or a bug. I mean, the file runs as the database user &uberspace_username you created in the postgresql guide. The script tells to create a new user and database and extensions. Why does it need a database named identical with the username? When its a bug as workaround I created the database $uberspace_username how I described in the prequesites: [isabell@stardust ~]$ createdb --encoding=UTF8 --owner=<username> <username>

::

 [isabell@stardust ~]$ psql -f ~/pleroma/config/setup_db.psql
 CREATE ROLE
 CREATE DATABASE
 You are now connected to database "pleroma" as user "isabell".
 CREATE EXTENSION
 CREATE EXTENSION
 CREATE EXTENSION
 [isabell@stardust ~]$

Database migration
------------------

.. note:: For these next steps, the default will be to run pleroma using the dev configuration file, ``config/dev.secret.exs``. To run them using the prod config file, prefix each command at the shell with ``MIX_ENV=prod``. For example: ``MIX_ENV=prod mix phx.server``. Documentation for the config can be found at docs/config.md in the repository, or at the "Configuration" page on https://docs-develop.pleroma.social/config.html

Make a copy of the file ``generated_config.exs`` in the directory ``~/pleroma/config`` and rename it to ``dev.secret.exs``. ``cd`` the root directory of Pleroma and run ``mix ecto.migrate`` to migrate the database.

::

 [isabell@stardust ~]$ cp ~/pleroma/config/generated_config.exs ~/pleroma/config/dev.secret.exs
 [isabell@stardust ~]$ cd ~/pleroma
 [isabell@stardust ~]$ mix ecto.migrate
 [isabell@stardust ~]$

Configure web server
--------------------

.. note:: Pleroma is running on port 4000 in the default configuration.

To access the front end you have to set a new backend. You need the domain and the port you configured earlier.

.. include:: includes/web-backend.rst

As example for this guide:

::

 [isabell@stardust ~]$ uberspace web backend set isabell.uber.space --http --port 4000
 Set backend for isabell.uber.space/ to port 4000; please make sure something is listening!
 You can always check the status of your backend using "uberspace web backend list".
 [isabell@stardust ~]$

.. Comment out because its not necessary
.. Start Pleroma
 =============

 With ``mix phx.server`` you can start Pleroma in the debug mode.

 ::

  [isabell@stardust ~] cd ~/pleroma
  [isabell@stardust ~] mix phx.server

 To stop the service type an ``a`` in the terminal and press Enter.

Setup deamon
============

Create ``~/etc/services.d/pleroma.ini`` with the following content and make sure to replace ``<username>`` with your Uberspace username:

.. code-block:: ini

 ; Assumes pleroma is installed in /home/<username>/pleroma and running as the pleroma user
 ; Also assumes mix is in /usr/bin, this might differ on BSDs or niche Linux distros
 ; Logs into /home/<username>/logs
 [program:pleroma]
 command=/usr/bin/mix phx.server
 directory=/home/<username>/pleroma
 autostart=true
 autorestart=true
 user=<username>
 environment =
   MIX_ENV=dev,
   HOME=/home/<username>,
   USER=<username>,
   PATH="/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/home/<username>/bin:%(ENV_PATH)s",
   PWD=/home/<username>/pleroma
 stdout_logfile=/home/<username>/logs/stdout.log
 stdout_logfile_maxbytes=50MB
 stdout_logfile_backups=10
 stderr_logfile=/home/<username>/logs/stderr.log
 stderr_logfile_maxbytes=50MB
 stderr_logfile_backups=10

.. include:: includes/supervisord.rst

If it's not in state RUNNING, check your configuration.

Finishing Installation
======================

Create your first user as admin with ``mix pleroma.user new <nickname> <email> [option ...]``:

::

 [isabell@stardust ~]$ cd ~/pleroma
 [isabell@stardust ~]$ mix pleroma.user new isabell isabell@uber.space --password MySuperSecretPassword --admin
 A user will be created with the following information:
   - nickname: isabell
   - email: isabell@uber.space
   - password: MySuperSecretPassword
   - name: isabell
   - bio:
   - moderator: false
   - admin: true

 Continue? [Yn] Y
 [...]
 [isabell@stardust ~]$

Updates
=======

Stop the Pleroma service: 

::

 [isabell@stardust ~]$ supervisorctl stop pleroma
 pleroma: stopped
 [isabell@stardust ~]$

``cd`` to your Pleroma directory and run ``git pull`` to pull the latest changes from upstream, install new dependencies and migrate the database.

::

 [isabell@stardust ~]$ cd ~/pleroma
 [isabell@stardust ~]$ git pull origin stable
 remote: Enumerating objects: 549, done.
 remote: Counting objects: 100% (549/549), done.
 remote: Compressing objects: 100% (51/51), done.
 remote: Total 816 (delta 514), reused 498 (delta 498), pack-reused 267
 Receiving objects: 100% (816/816), 2.42 MiB | 3.48 MiB/s, done.
 Resolving deltas: 100% (591/591), completed with 158 local objects.
 From https://git.pleroma.social/pleroma/pleroma
  * branch                stable     -> FETCH_HEAD
    a5ccb5b0b..f891e2b2f  stable     -> origin/stable
 Updating a5ccb5b0b..f891e2b2f
 Fast-forward
 [...]
 [isabell@stardust ~]$ mix deps.get
 [isabell@stardust ~]$ mix ecto.migrate
 [isabell@stardust ~]$ supervisorctl start pleroma
 [isabell@stardust ~]$

----

Tested with Pleroma 2.0.7, Uberspace 7.7.1.2

.. _Pleroma: https://pleroma.social
.. _GNU Social: https://gnu.io/social/
.. _Mastodon: https://joinmastodon.org/

.. author_list::
